<html>

<head>
    <title>STT WDC</title>
    <meta http-equiv="Cache-Control" content="no-store" />

    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js" type="text/javascript"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" crossorigin="anonymous"></script>

    <script src="https://connectors.tableau.com/libs/tableauwdc-2.3.latest.js" type="text/javascript"></script>
    <script type="text/javascript">
      
        (function () {
            var myConnector = tableau.makeConnector();
            tableau.registerConnector(myConnector);

            myConnector.getColumnHeaders = function () {
                var fieldNames = ['open', 'high', 'low', 'close', 'volume'];
                var fieldTypes = ['float', 'float', 'float', 'float', 'float'];
                tableau.headersCallback(fieldNames, fieldTypes);
            }

            myConnector.getTableData = function (lastRecordToken){

                var dataToReturn = [];
                var hasMoreData = false;

                var connectionUri = "https://www.alphavantage.co/query?function=TIME_SERIES_INTRADAY&symbol=STT&interval=1min&apikey=K2U4GVW0LBUE70CG";

                var xhr = $.ajax({
                    url: connectionUri,
                    dataType: 'json',
                    success: function (data){
                        
                        if(data.query.results) {
                            var quotes = data.query.results.quote;
                            var ii;
                            for(ii = 0; ii<quotes.length; ++ii){
                                var entry = {
                                    'open' : quotes[ii].open,
                                    'high' : quotes[ii].high,
                                    'low' : quotes[ii].low,
                                    'close' : quotes[ii].close,
                                    'volume' : quotes[ii].volume
                                };

                                dataToReturn.push(entry);
                            }
                            tableau.dataCallback(dataToReturn, lastRecordToken, false);
                        }
                        else {
                            tableau.abortWithError("No results found");
                        }
                    },
                    error: function (xhr, ajaxOptions, thrownError){
                        document.write("error");
                        tableau.log("Connection error");
                        tableau.abortWithError("Error while trying to connect to API");
                    }
                });

            }

            

        })();

        $(document).ready(function (){
            document.write("i am here");
            $("#submitButton").click(function (){
                var tickerSymbol = "STT";
                tableau.connectionName = "Stock Data for " + tickerSymbol;
                tableau.connectionData = tickerSymbol;
                tablea.submit();
            });
        });
    </script>
</head>

<body>
        <button type="button" id="submitButton" class="btn-success" style="margin: 10px;">Get STT Stock Quotes!</button>

</body>

</html>
